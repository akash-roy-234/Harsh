# Import the required modules
Import-Module Az
Import-Module Microsoft.Graph

# Connect to Azure and Microsoft Graph
Connect-AzAccount
Connect-MgGraph -Scopes "Policy.Read.All"

# Set variables
$subscriptionId = "c3212b68-b822-4c28-bfc0-c0d0f0cf9d0"  # Your Subscription ID
$resourceGroupName = "RG-TERRAFORM-001"  # Resource Group Name
$storageAccountName = "stcrpsbx001dtf"  # Storage Account Name
$containerName = "conditionalaccessip"  # Container Name
$fileName = "ConditionAccessIPs.txt"

# Set the subscription context
Select-AzSubscription -SubscriptionId $subscriptionId

# Function to get Conditional Access policies using Microsoft Graph
function Get-ConditionalAccessPolicy {
    $policies = Get-MgConditionalAccessPolicy
    return $policies
}

# Function to extract IP addresses from Conditional Access policies
function Extract-IPsFromPolicies {
    param (
        $policies
    )
    $ipList = @()
    foreach ($policy in $policies) {
        if ($policy.Conditions.Applications.IncludeAllApplications -and $policy.Conditions.Locations) {
            $locations = $policy.Conditions.Locations
            if ($locations.IncludeLocations) {
                $locationIds = $locations.IncludeLocations
                foreach ($locationId in $locationIds) {
                    $namedLocation = Get-MgIdentityConditionalAccessNamedLocation -ConditionalAccessNamedLocationId $locationId
                    if ($namedLocation.ODataType -eq "#microsoft.graph.ipNamedLocation") {
                        $ipList += $namedLocation.IpRanges
                    }
                }
            }
        }
    }
    return $ipList
}

# Function to store IPs in the Storage Account
function Store-IPsInStorageAccount {
    param (
        $ipList,
        $storageAccountName,
        $containerName,
        $fileName
    )
    
    # Get Storage Account Key
    $storageAccountKey = (Get-AzStorageAccountKey -ResourceGroupName $resourceGroupName -Name $storageAccountName).Value[0]
    
    # Create a storage context
    $context = New-AzStorageContext -StorageAccountName $storageAccountName -StorageAccountKey $storageAccountKey
    
    # Create a blob container if it doesn't exist
    $container = Get-AzStorageContainer -Context $context -Name $containerName -ErrorAction SilentlyContinue
    if (-not $container) {
        $container = New-AzStorageContainer -Context $context -Name $containerName
    }
    
    # Write IPs to a file
    $filePath = "$PSScriptRoot\$fileName"
    $ipList | Out-File -FilePath $filePath
    
    # Upload the file to the blob container
    Set-AzStorageBlobContent -File $filePath -Container $containerName -Blob $fileName -Context $context
}

# Main logic
$policies = Get-ConditionalAccessPolicy
$ipList = Extract-IPsFromPolicies -policies $policies

if ($ipList.Count -gt 0) {
    Store-IPsInStorageAccount -ipList $ipList -storageAccountName $storageAccountName -containerName $containerName -fileName $fileName
    Write-Host "IP addresses have been successfully extracted and stored in the Storage Account."
} else {
    Write-Host "No IP addresses found in Conditional Access policies."
}
